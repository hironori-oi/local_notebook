version: '3.8'

services:
  janus:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: janus-server
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - MODEL_NAME=deepseek-ai/Janus-Pro-7B
      - DEVICE=cuda
      - TORCH_DTYPE=bfloat16
      - DEFAULT_WIDTH=384
      - DEFAULT_HEIGHT=384
      - DEFAULT_CFG_WEIGHT=5.0
      - DEFAULT_TEMPERATURE=1.0
      # Hugging Face cache
      - HF_HOME=/app/.cache/huggingface
      - TRANSFORMERS_CACHE=/app/.cache/huggingface
    volumes:
      # Persist model cache
      - janus_cache:/app/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:9000/health').raise_for_status()"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 180s  # Model loading takes time

volumes:
  janus_cache:
    driver: local
